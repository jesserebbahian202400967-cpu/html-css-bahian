<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill Calculator</title>
  <link rel="stylesheet" href="calculator.css">
</head>
<body>

<nav class="navbar">
  <a href="profile.html">
    <img src="profile.png.webp" class="avatar">
  </a>
  <ul>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="calculator.html" class="active">Calculator</a></li>
    <li><a href="history.html">History</a></li>
    <li><a href="login.html">Log out</a></li>
  </ul>
</nav>

<div class="main">

  <div class="form-box">
    <h2>Electricity Bill Calculator</h2>
    <p class="sub">Fill out the info below</p>

    <label>Month</label>
    <input type="text" id="month" placeholder="Ex: January">

    <label>Power Used (kWh)</label>
    <input type="number" id="consumption" placeholder="Ex: 200">

    <label>Price per kWh (₱)</label>
    <input type="number" id="rate" placeholder="Ex: 12">

    <button onclick="myFunction()">Calculate</button>
  </div>

  <div class="result-box">
    <h3>Your Estimated Bill:</h3>
    <h1 id="totalBill">₱0.00</h1>
    <p class="note">Calculation: kWh × Rate</p>
  </div>

</div>

<!-- Load Supabase SDK, config and auth helpers -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth-guard.js"></script>
<script src="js/auth.js"></script>
<script src="js/database.js"></script>
<script>requireAuth();</script>

<script>
async function myFunction() {
  const month = document.getElementById("month").value.trim();
  const consumptionRaw = document.getElementById("consumption").value;
  const rateRaw = document.getElementById("rate").value;

  const resultDisplay = document.getElementById("totalBill");

  if (!month || consumptionRaw === "" || rateRaw === "") {
    alert("Please fill in all fields.");
    return;
  }

  const consumption = parseFloat(consumptionRaw);
  const rate = parseFloat(rateRaw);

  if (Number.isNaN(consumption) || Number.isNaN(rate) || consumption < 0 || rate < 0) {
    alert("Please enter valid positive numbers for consumption and rate.");
    return;
  }

  const total = consumption * rate;

  resultDisplay.textContent = `₱${total.toFixed(2)}`;

  // Save calculation to Supabase database
  try {
    // Using 0 for previous reading and consumption for current reading
    // Adjust these based on your actual form inputs
    const result = await saveCalculation(month, 0, consumption, rate, total, consumption);
    
    if (result.success) {
      console.log('Calculation saved to database:', result.data);
      alert('Calculation saved successfully!');
    } else {
      console.warn('Failed to save to database:', result.message);
      alert('Calculation saved locally but failed to sync to database');
    }
  } catch (err) {
    console.error('Error saving calculation:', err);
    alert('Error saving calculation');
  }
}
</script>


</body>
</html>
